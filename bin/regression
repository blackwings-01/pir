#!/bin/bash

APPS=()
#APPS+=('DotProduct')
#APPS+=('OuterProduct')
#APPS+=('TPCHQ6')
APPS+=('BlackScholes')
APPS+=('GDA')
APPS+=('GEMM_Blocked')
APPS+=('LogReg')
APPS+=('SGD_minibatch')
APPS+=('Kmeans')
APPS+=('SPMV_ELL')
APPS+=('P4')
APPS+=('lenet_loops')
APPS+=('DoubleLoad')
APPS+=('PensieveStream')

logDir=out/regression/

if [[ $1 == *"s" ]]; then
    for log in $logDir/*.log; do
      echo $log=================
      fail=$(grep "\[fail\]\|\[error\]" $log)
      success=$(grep "success" $log)
      if [[ $fail || $success ]]; then
        echo $fail$success
      else
        tail $log
      fi
    done

elif [[ $1 == *"r" ]]; then
    mkdir -p $logDir
    for APP in ${APPS[@]}; do
      echo running $APP
      log=$logDir/$APP.log
      [ -e $log ] && rm $log
      bin/pir $APP $@ > $log 2>&1 &
      pids[${i}]=$!
      sleep 1
      echo numer of process running ${#pids[@]}
      if [[ ${#pids[@]} -ge 3 ]]; then
         # wait for all pids
         for pid in ${pids[*]}; do
             wait $pid
         done
         pids=()
      fi
    done
    
fi
